<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <meta http-equiv="Content-Language" content="en">
<link rel="alternate" hreflang="en" href=" http://blog.marcosbarbero.com/ha-and-zone-affinity-spring-cloud-eureka/"/>
<link rel="alternate" hreflang="pt_BR" href="http://blog.marcosbarbero.com/pt_BR/ha-and-zone-affinity-spring-cloud-eureka/"/>


  <title>HA and Zone Affinity With Spring Cloud Netflix Eureka</title>

  <script>
  </script>

  <meta name="author" content="Marcos Barbero" />

  

  <link rel="alternate" type="application/rss+xml" title="Marcos Barbero's Blog - I create things and I blog about it... sometimes." href="/feed.xml" />

  

  
    
      
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />

    
  

  
    
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/css/main.css" />
    
      <link rel="stylesheet" href="/css/flags.min.css" />
    
  

  
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="HA and Zone Affinity With Spring Cloud Netflix Eureka" />
  

   
  <meta property="og:description" content="This tutorial will guide you through the process to setup zone affinity in Spring Cloud Netflix Eureka. What You Will Build You will build three applications: API Gateway - Spring Cloud Netflix Zuul Service Registry - Spring Cloud Netflix Eureka REST Service - Spring Cloud All those are necessary to...">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="http://blog.marcosbarbero.com/ha-and-zone-affinity-spring-cloud-eureka/" />
  <link rel="canonical" href="http://blog.marcosbarbero.com/ha-and-zone-affinity-spring-cloud-eureka/" />
  

  
  <meta property="og:image" content="/img/ha-discovery.jpg" />
  


  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
  <meta name="twitter:title" content="HA and Zone Affinity With Spring Cloud Netflix Eureka" />
  

  
  <meta name="twitter:description" content="This tutorial will guide you through the process to setup zone affinity in Spring Cloud Netflix Eureka. What You Will Build You will build three applications: API Gateway - Spring Cloud Netflix Zuul Service Registry - Spring Cloud Netflix Eureka REST Service - Spring Cloud All those are necessary to...">
  

  
  <meta name="twitter:image" content="/img/ha-discovery.jpg" />
  

  

</head>


  <body>

    
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand" href="http://blog.marcosbarbero.com">Marcos Barbero's Blog</a>
      
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">

      
        
        
        
        
          
        
      
        
        
          
            
              <li>
                <a href="/about/">About me</a>
              </li>
            
          
        
      
        
        
      
        
        
          
        
      
        
        
      
        
        
          
        
      
        
        
      
        
        
          
        
      


      

        
        <li>
          <a href=" /ha-and-zone-affinity-spring-cloud-eureka/ ">
            <img src="/img/blank.gif" class="flag  flag-us " />
          </a>
        </li>
        
        <li>
          <a href=" /pt_BR/ha-and-zone-affinity-spring-cloud-eureka/ ">
            <img src="/img/blank.gif" class="flag  flag-br " />
          </a>
        </li>
        
      </ul>
    </div>

	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="http://blog.marcosbarbero.com">
	      <img class="avatar-img" src="/img/avatar.jpeg" />
		  </a>
	  </div>
	</div>
	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->




  <div id="header-big-imgs" data-num-img=1
    
	  
	  
	    
		  data-img-src-1="/img/ha-discovery.jpg"
		
	  
    
  ></div>





<header class="header-section has-img">

<div class="big-img intro-header">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>HA and Zone Affinity With Spring Cloud Netflix Eureka</h1>          

		  
		  
		  
		  <span class="post-meta">Posted on March 4, 2018</span>
		  
        </div>
      </div>
    </div>
  </div>
  <span class='img-desc'></span>
</div>

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>HA and Zone Affinity With Spring Cloud Netflix Eureka</h1>
		  
		  
		  
		  <span class="post-meta">Posted on March 4, 2018</span>
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

      
        
        
        

        <div id="header-gh-btns">
          
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&repo=spring-cloud-eureka-zone-affinity&type=star&count=true" frameborder="0" scrolling="0" width="120px" height="20px"></iframe>
                
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&repo=spring-cloud-eureka-zone-affinity&type=fork&count=true" frameborder="0" scrolling="0" width="120px" height="20px"></iframe>
                
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&type=follow&count=true" frameborder="0" scrolling="0" width="220px" height="20px"></iframe>
              
            
          
        </div>
      

      <article role="main" class="blog-post">
        <p>This tutorial will guide you through the process to setup zone affinity in Spring Cloud Netflix Eureka.</p>

<h3 id="what-you-will-build">What You Will Build</h3>
<p>You will build three applications:</p>

<ul>
  <li>API Gateway - <a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix Zuul</a></li>
  <li>Service Registry - <a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix Eureka</a></li>
  <li>REST Service - <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a></li>
</ul>

<p>All those are necessary to make sure that our zone affinity setup is correct. Each of them will be deployed 
twice, one per zone.</p>

<h3 id="pre-req">Pre-Req</h3>

<ul>
  <li><a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK 1.8</a></li>
  <li>Text editor or your favorite IDE</li>
  <li><a href="https://maven.apache.org/download.cgi">Maven 3.0+</a></li>
</ul>

<h3 id="zone-affinity">Zone Affinity</h3>
<p>It doesn’t matter which kind of architectural style the application is using, it’s a common use case to have the same application deployed 
in different regions/data centers and use some technique to keep the requests within the same zone.</p>

<p>In microservices architecture, there’s also a need to achieve the same thing but the technique needs to be applied using the 
<a href="http://microservices.io/patterns/service-registry.html">Service Registry Design Pattern</a>.</p>

<h3 id="spring-cloud-netflix">Spring Cloud Netflix</h3>
<p><a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix</a> 
makes it easy to implement the necessary <a href="http://microservices.io/patterns/">patterns for microservices</a>.</p>

<h3 id="creating-the-applications">Creating the Applications</h3>
<p>In this guide, we’ll create three applications, and if you’re familiar with spring-cloud, it will be an easy job, 
all the created applications are nothing more than a simple runnable spring-boot jar.</p>

<p>The main part here is the configuration files that will be shown further on.</p>

<h3 id="base-dependencies">Base Dependencies</h3>
<p>Add the following dependencies for all the applications. If there’s any diff for any specific application, it will be mentioned in each specific thread.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code>    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.5.9.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;dependencyManagement&gt;</span>
        <span class="nt">&lt;dependencies&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>Edgware.SR2<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;/dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-eureka<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
</code></pre>
</div>

<h3 id="api-gateway">API Gateway</h3>
<p>The first application we’ll create will be the API Gateway using 
<a href="https://cloud.spring.io/spring-cloud-netflix">Spring Cloud Netflix Zuul</a>.
First, add the following dependency in the pom.xml.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">zuul</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre>
</div>

<h4 id="java-configuration">Java Configuration</h4>
<p>Now just create the main SpringApplication class adding <code class="highlighter-rouge">@EnableZuulProxy</code>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.zuul.EnableZuulProxy</span><span class="o">;</span>

<span class="nd">@EnableZuulProxy</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GatewayApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">GatewayApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="service-registry">Service Registry</h3>
<p>The second application we’ll create will be the Service Registry using 
<a href="https://cloud.spring.io/spring-cloud-netflix">Spring Cloud Netflix Eureka</a>.
First, add the following dependency in the pom.xml.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<h4 id="java-configuration-1">Java Configuration</h4>
<p>Now just create the main SpringApplication class adding @EnableEurekaServer.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class="o">;</span>

<span class="nd">@EnableEurekaServer</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceDiscoveryApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ServiceDiscoveryApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="simple-rest-service">Simple REST Service</h3>
<p>The third application contains nothing more than a REST endpoint to make sure that each call from each 
region will remain in the requested region. For this application, there’s nothing to add to the base pom.xml.</p>

<h4 id="java-configuration-2">Java Configuration</h4>
<p>To make things easier, I’m creating the main class with a nested RestController, the following controller returns which zone is this application deployed.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_UTF8_VALUE</span><span class="o">;</span>

<span class="nd">@EnableDiscoveryClient</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SimpleService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@RestController</span>
    <span class="kd">class</span> <span class="nc">SimpleController</span> <span class="o">{</span>
        <span class="nd">@Value</span><span class="o">(</span><span class="s">"${eureka.instance.metadataMap.zone}"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">zone</span><span class="o">;</span>
        <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/zone"</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="n">APPLICATION_JSON_UTF8_VALUE</span><span class="o">)</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">zone</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"{\"zone\"=\""</span> <span class="o">+</span> <span class="n">zone</span> <span class="o">+</span> <span class="s">"\"}"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="configuration-properties">Configuration Properties</h4>
<p>As it was previously mentioned, each application needs to run twice in order to simulate two distinct regions, 
to make it easier we’ll create the configuration based on <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html">profiles</a>, 
for each application create the following three files:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>src/main/resources/application.yml
src/main/resources/application-zone1.yml
src/main/resources/application-zone2.yml
</code></pre>
</div>

<p class="box-note">The suffix in the filename will be used as the profile name.</p>

<h4 id="service-registry-1">Service Registry</h4>
<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application.yml</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">client</span><span class="pi">:</span>
    <span class="s">register-with-eureka</span><span class="pi">:</span> <span class="s">false</span>
    <span class="s">fetch-registry</span><span class="pi">:</span> <span class="s">false</span>
    <span class="s">region</span><span class="pi">:</span> <span class="s">region-1</span>
    <span class="s">service-url</span><span class="pi">:</span>
      <span class="s">zone1</span><span class="pi">:</span> <span class="s">http://localhost:8761/eureka/</span>
      <span class="s">zone2</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8762/eureka/</span>
    <span class="s">availability-zones</span><span class="pi">:</span>
      <span class="s">region-1</span><span class="pi">:</span> <span class="s">zone1,zone2</span>
<span class="s">spring.profiles.active</span><span class="pi">:</span> <span class="s">zone1</span>
</code></pre>
</div>

<p>All the following properties are in eureka.client namespace.</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>region</td>
      <td>A String containing a name for the region where the application will be deployed</td>
    </tr>
    <tr>
      <td>service-url</td>
      <td>A Map containing the list of available zones for the given region</td>
    </tr>
    <tr>
      <td>availability-zones</td>
      <td>A Map containing a comma-separated list of zones for the given region</td>
    </tr>
  </tbody>
</table>

<p>The properties register-with-eureka and fetch-registry are disabling the Service Registry to be added in the applications list but it’s not that important for this setup.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone1.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8761</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">instance</span><span class="pi">:</span>
    <span class="s">hostname</span><span class="pi">:</span> <span class="s">localhost</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone1</span>
</code></pre>
</div>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone2.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8762</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">instance</span><span class="pi">:</span>
    <span class="s">hostname</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone2</span>
</code></pre>
</div>

<p>For the <code class="highlighter-rouge">-zone1</code> and <code class="highlighter-rouge">-zone2</code> profiles the only difference are the server.port, the actual zone 
configured in eureka.metadataMap.zone, and in this case the hostname, each Eureka Server needs 
to run in a different hostname; as I’m running both in the same machine I’m naming it as 127.0.01 and localhost.</p>

<p class="box-note">It’s not necessary to add the hostname in case you are running on different machines.</p>

<h4 id="gateway">Gateway</h4>
<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application.yml</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">client</span><span class="pi">:</span>
    <span class="s">prefer-same-zone-eureka</span><span class="pi">:</span> <span class="s">true</span>
    <span class="s">region</span><span class="pi">:</span> <span class="s">region-1</span>
    <span class="s">service-url</span><span class="pi">:</span>
      <span class="s">zone1</span><span class="pi">:</span> <span class="s">http://localhost:8761/eureka/</span>
      <span class="s">zone2</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8762/eureka/</span>
    <span class="s">availability-zones</span><span class="pi">:</span>
      <span class="s">region-1</span><span class="pi">:</span> <span class="s">zone1,zone2</span>
<span class="s">spring</span><span class="pi">:</span>
  <span class="s">profiles.active</span><span class="pi">:</span> <span class="s">zone1</span>
  <span class="s">application.name</span><span class="pi">:</span> <span class="s">gateway</span>
<span class="s">management.security.enabled</span><span class="pi">:</span> <span class="s">false</span>
</code></pre>
</div>

<p>The main difference here is the property <code class="highlighter-rouge">eureka.client.prefer-same-zone-eureka</code>, it is telling to the application that 
whenever it needs to make a call to another <code class="highlighter-rouge">EurekaClient</code> it will call it using the same zone where the caller is deployed. 
In case there’s no available client in the same zone, it will call from another zone in which it’s available.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone1.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8080</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">instance</span><span class="pi">:</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone1</span>
</code></pre>
</div>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone2.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8081</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">instance</span><span class="pi">:</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone2</span>
</code></pre>
</div>

<p>As before, this per profile configuration only changes the availability zone and the running port.</p>

<h4 id="simple-rest-service-1">Simple REST Service</h4>
<p>The configuration for the service itself contains the same configuration as the Gateway.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application.yml</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">client</span><span class="pi">:</span>
    <span class="s">prefer-same-zone-eureka</span><span class="pi">:</span> <span class="s">true</span>
    <span class="s">region</span><span class="pi">:</span> <span class="s">region-1</span>
    <span class="s">service-url</span><span class="pi">:</span>
      <span class="s">zone1</span><span class="pi">:</span> <span class="s">http://localhost:8761/eureka/</span>
      <span class="s">zone2</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8762/eureka/</span>
    <span class="s">availability-zones</span><span class="pi">:</span>
      <span class="s">region-1</span><span class="pi">:</span> <span class="s">zone1,zone2</span>
<span class="s">spring</span><span class="pi">:</span>
  <span class="s">profiles.active</span><span class="pi">:</span> <span class="s">zone1</span>
  <span class="s">application.name</span><span class="pi">:</span> <span class="s">simple-service</span>
</code></pre>
</div>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone1.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8181</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">instance</span><span class="pi">:</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone1</span>
</code></pre>
</div>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone2.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8182</span>
<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">instance</span><span class="pi">:</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone2</span>
</code></pre>
</div>

<h3 id="build--run">Build &amp; Run</h3>
<p>It’s time to build the applications; if you are building the application using maven (like I did), just build them executing:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mvn clean package
</code></pre>
</div>

<p>Right after that just run each application adding the specific profile to the command line, e.g:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>java -jar target/<span class="k">*</span>.jar --spring.profiles.active<span class="o">=</span>zone1
</code></pre>
</div>

<p class="box-note">Remember that you need to run each application twice, once each profile: zone1 and zone2.</p>

<h3 id="validation">Validation</h3>
<p>To validate if the requests are respecting each zone we need to make a request to the simple-service through each gateway.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl http://localhost:8080/simple-service/zone
<span class="o">{</span><span class="s2">"zone"</span><span class="o">=</span><span class="s2">"zone1"</span><span class="o">}</span>
<span class="gp">$ </span>curl http://localhost:8081/simple-service/zone
<span class="o">{</span><span class="s2">"zone"</span><span class="o">=</span><span class="s2">"zone2"</span><span class="o">}</span>
</code></pre>
</div>

<p class="box-note">The difference between each zone here is the server.port.</p>

<h3 id="zone-failover-validation">Zone Failover Validation</h3>
<p>To validate the failover between zones you just need to stop one of the instances and make a request to the opposite zone, e.g:</p>

<ol>
  <li>Stop simple-service on zone2.</li>
  <li>Make a request to simple-service through the gateway on zone2.</li>
</ol>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl http://localhost:8081/simple-service/zone
</code></pre>
</div>

<p>The expected result now will be a <code class="highlighter-rouge">JSON</code> containing <code class="highlighter-rouge"><span class="p">{</span><span class="nt">"zone"</span><span class="err">=</span><span class="nt">"zone1"</span><span class="err">}</span></code>.<br />
Once the simple-service for zone1 is up, running and registered in Eureka Server the same curl has to respond <code class="highlighter-rouge"><span class="p">{</span><span class="nt">"zone"</span><span class="err">=</span><span class="nt">"zone2"</span><span class="err">}</span></code> again.</p>

<p class="box-note">It takes a while to the simple-service be available in the opposite zone, be patient and have fun!</p>

<h3 id="summary">Summary</h3>
<p>Congratulations! You just created and configured an API Gateway, Service Registry and a Simple REST Service that respects zone affinity bringing to your microservices more resilience and HA.</p>

<h3 id="footnote">Footnote</h3>
<ul>
  <li>The code used for this tutorial can be found on <a href="https://github.com/weekly-drafts/spring-cloud-eureka-zone-affinity">github</a></li>
</ul>

      </article>

      
        <div class="blog-tags">
          Tags:
          
          
            <a href="/tags#spring-framework">spring-framework</a>
          
            <a href="/tags#spring-cloud">spring-cloud</a>
          
            <a href="/tags#netflix">netflix</a>
          
            <a href="/tags#tutorial">tutorial</a>
          
          
        </div>
      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
  <!--- Share on Twitter -->
    <a href="https://twitter.com/intent/tweet?text=HA+and+Zone+Affinity+With+Spring+Cloud+Netflix+Eureka+http://blog.marcosbarbero.com/ha-and-zone-affinity-spring-cloud-eureka/"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fa fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
  <!--- Share on Facebook -->
    <a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.marcosbarbero.com/ha-and-zone-affinity-spring-cloud-eureka/"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fa fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
  <!--- Share on Google Plus -->
    <a href="https://plus.google.com/share?url=http://blog.marcosbarbero.com/ha-and-zone-affinity-spring-cloud-eureka/"
      class="btn btn-social-icon btn-google" title="Share on Google+">
      <span class="fa fa-fw fa-google-plus" aria-hidden="true"></span>
      <span class="sr-only">Google+</span>
    </a>
  

  
  <!--- Share on LinkedIn -->
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://blog.marcosbarbero.com/ha-and-zone-affinity-spring-cloud-eureka/"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fa fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

</section>



      

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="/setup-multiple-datasources-with-spring-boot-spring-data-in-pcf/" data-toggle="tooltip" data-placement="top" title="Setup multiple DataSources with Spring Boot and Spring Data in PCF">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="/spring-cloud-netflix-zuul-rate-limit/" data-toggle="tooltip" data-placement="top" title="Adding Rate Limit for Spring Cloud Netflix Zuul">Next Post &rarr;</a>
        </li>
        
      </ul>

      
        <div class="disqus-comments">
          <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'marcosbarbero';
        /* ensure that pages with query string get the same discussion */
            var url_parts = window.location.href.split("?");
            var disqus_url = url_parts[0];
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        </div>
      
    </div>
  </div>
</div>


    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links"><li><a href="/feed.xml" title="RSS"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">RSS</span>
              </a>
            </li><li><a href="mailto:marcos.hgb@gmail.com" title="Email me"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Email me</span>
              </a>
            </li><li><a href="https://github.com/marcosbarbero" title="GitHub"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">GitHub</span>
              </a>
            </li><li><a href="https://twitter.com/marcosgbarbero" title="Twitter"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Twitter</span>
              </a>
            </li><li><a href="https://linkedin.com/in/marcosbarbero" title="LinkedIn"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">LinkedIn</span>
              </a>
            </li></ul>
      <p class="copyright text-muted">
      Marcos Barbero
      &nbsp;&bull;&nbsp;
      2018

      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.marcosbarbero.com">blog.marcosbarbero.com</a>
      

      
      </p>
          <!-- Please don't remove this, keep my open source work credited :) -->
    <p class="theme-by text-muted">
      Theme by
      <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    </p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/main.js"></script>
    
  



	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-54888300-2', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->


  
  </body>
</html>
