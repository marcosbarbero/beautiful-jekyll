<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <meta http-equiv="Content-Language" content="pt_BR">
<link rel="alternate" hreflang="en" href=" http://0.0.0.0:4000/blue-green-deployment-spring-cloud-netflix/"/>
<link rel="alternate" hreflang="pt_BR" href="http://0.0.0.0:4000/pt_BR/blue-green-deployment-spring-cloud-netflix/"/>


  <title>Blue-Green Deployment with Spring Cloud Netflix Stack</title>

  <script>
  </script>

  <meta name="author" content="Marcos Barbero" />

  

  <link rel="alternate" type="application/rss+xml" title="Marcos Barbero's Blog - Eu crio coisas e escrevo sobre isso... às vezes." href="/pt_BR/feed.xml" />

  

  
    
      
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />

    
  

  
    
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/css/main.css" />
    
      <link rel="stylesheet" href="/css/flags.min.css" />
    
  

  
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="Blue-Green Deployment with Spring Cloud Netflix Stack" />
  

   
  <meta property="og:description" content="This guide walks through the process of achieving Blue Green Deployment with Spring Cloud Netflix stack. Introduction Blue-Green deployment is a technique used for CI / CD where you have two environments with different versions of your app deployed and one of the environments you use for production and the...">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="http://0.0.0.0:4000/blue-green-deployment-spring-cloud-netflix/" />
  <link rel="canonical" href="http://0.0.0.0:4000/pt_BR/blue-green-deployment-spring-cloud-netflix/" />
  

  
  <meta property="og:image" content="http://0.0.0.0:4000/img/avatar.jpeg" />
  


  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
  <meta name="twitter:title" content="Blue-Green Deployment with Spring Cloud Netflix Stack" />
  

  
  <meta name="twitter:description" content="This guide walks through the process of achieving Blue Green Deployment with Spring Cloud Netflix stack. Introduction Blue-Green deployment is a technique used for CI / CD where you have two environments with different versions of your app deployed and one of the environments you use for production and the...">
  

  
  <meta name="twitter:image" content="http://0.0.0.0:4000/img/avatar.jpeg" />
  

  

</head>


  <body>

    
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand" href="http://0.0.0.0:4000/pt_BR/">Marcos Barbero's Blog</a>
      
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">

      
        
        
        
        
          
        
      
        
        
          
            
              <li>
                <a href="/pt_BR/about/">Sobre mim</a>
              </li>
            
          
        
      
        
        
      
        
        
          
        
      
        
        
          
        
      
        
        
      
        
        
          
        
      


      

        
        <li>
          <a href=" /blue-green-deployment-spring-cloud-netflix/ ">
            <img src="/img/blank.gif" class="flag  flag-us " />
          </a>
        </li>
        
        <li>
          <a href=" /pt_BR/blue-green-deployment-spring-cloud-netflix/ ">
            <img src="/img/blank.gif" class="flag  flag-br " />
          </a>
        </li>
        
      </ul>
    </div>

	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="http://0.0.0.0:4000/pt_BR/">
	      <img class="avatar-img" src="/img/avatar.jpeg" />
		  </a>
	  </div>
	</div>
	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->








<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Blue-Green Deployment with Spring Cloud Netflix Stack</h1>
		  
		  
		  
		  <span class="post-meta">Posted on July 3, 2018</span>
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

      
        
        
        

        <div id="header-gh-btns">
          
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&repo=blue-green-deployment-spring-cloud-netflix&type=star&count=true" frameborder="0" scrolling="0" width="120px" height="20px"></iframe>
                
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&repo=blue-green-deployment-spring-cloud-netflix&type=fork&count=true" frameborder="0" scrolling="0" width="120px" height="20px"></iframe>
                
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&type=follow&count=true" frameborder="0" scrolling="0" width="220px" height="20px"></iframe>
              
            
          
        </div>
      

      <article role="main" class="blog-post">
        <p>This guide walks through the process of achieving <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">Blue Green Deployment</a>
with <a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix</a> stack.</p>

<h3 id="introduction">Introduction</h3>

<p>Blue-Green deployment is a technique used for <a href="https://martinfowler.com/articles/continuousIntegration.html">CI</a> /
<a href="https://martinfowler.com/bliki/ContinuousDelivery.html">CD</a> where you have two environments with different versions
of your app deployed and one of the environments you use for production and the second one you can you for the final
test phase before sending the real traffic. This approach gives you a way for a rapid rollback if for some reason 
anything goes wrong.</p>

<p>There are quite few ways to achive blue-green deployment, in this guide I’ll describe how to do that using 
<a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix</a> stack.</p>

<h3 id="pre-req">Pre-req</h3>

<ul>
  <li><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 1.8</a></li>
  <li>Text editor or your favorite IDE</li>
  <li><a href="https://maven.apache.org/download.cgi">Maven 3.0+</a></li>
  <li><a href="https://cloud.spring.io/spring-cloud-cli/">Spring Cloud CLI</a></li>
</ul>

<h3 id="architecture-overview">Architecture overview</h3>

<p>In our architecture we will have an <code class="highlighter-rouge">API Gateway</code> routing all the traffic to the downstream applications,
we will be also using <a href="http://microservices.io/patterns/service-registry.html">Service Registry Design Pattern</a>
to enable <a href="http://microservices.io/patterns/client-side-discovery.html">Client-Side Load Balancing</a>.</p>

<div style="text-align:center">
    <img src="/img/blue-green-arch-overview.png" />
</div>

<h3 id="discovery-service">Discovery Service</h3>
<p>We will be using <code class="highlighter-rouge">Spring Cloud Netflix Eureka</code> to solve the 
<a href="http://microservices.io/patterns/service-registry.html">Service Registry Design Pattern</a>. The easiest way
to have an <code class="highlighter-rouge">Eureka Server</code> up and running is installing <a href="https://cloud.spring.io/spring-cloud-cli/">Spring Cloud CLI</a>,
with that in place just run the following command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>spring cloud eureka
</code></pre>
</div>

<p>This command will spin up an <code class="highlighter-rouge">Eureka Server</code> running at <code class="highlighter-rouge">http://localhost:8761</code>.</p>

<h3 id="downstream-service">Downstream Service</h3>

<p>The downstream service is very simple, it only shows which environment the application is deployed, it can
be either <code class="highlighter-rouge">green</code> or <code class="highlighter-rouge">blue</code>.</p>

<p>To create this app I just went to <a href="http://start.spring.io/">start.spring.io</a> and selected <code class="highlighter-rouge">Web</code> and 
<code class="highlighter-rouge">Eureka Discovery</code> as dependency, and then I added the following configuration:</p>

<p><code class="highlighter-rouge">src/main/resources/application.yml</code></p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">spring</span><span class="pi">:</span>
  <span class="s">application</span><span class="pi">:</span>
    <span class="s">name</span><span class="pi">:</span> <span class="s">bluegreen</span>

<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">instance</span><span class="pi">:</span>
    <span class="s">metadata-map</span><span class="pi">:</span>
      <span class="s">env</span><span class="pi">:</span> <span class="s">green</span>

<span class="nn">---</span>
<span class="s">spring</span><span class="pi">:</span>
  <span class="s">profiles</span><span class="pi">:</span> <span class="s">blue</span>

<span class="s">server</span><span class="pi">:</span>
  <span class="s">port</span><span class="pi">:</span> <span class="s">8081</span>

<span class="s">eureka</span><span class="pi">:</span>
  <span class="s">instance</span><span class="pi">:</span>
    <span class="s">metadata-map</span><span class="pi">:</span>
      <span class="s">env</span><span class="pi">:</span> <span class="s">blue</span>
</code></pre>
</div>

<p>The configuration above contains two profiles, the <code class="highlighter-rouge">default</code> profile is used for the <code class="highlighter-rouge">green</code> environment,
and <code class="highlighter-rouge">blue</code> profile that’s used for the <code class="highlighter-rouge">blue</code> environment. Another important piece in this configuration 
is the <code class="highlighter-rouge">eureka.instance.metadata-map</code>, it will be used by the <code class="highlighter-rouge">API Gateway</code> to route the requests to the
correct environment.</p>

<p>To validate the environment just create a <code class="highlighter-rouge">controller</code> that returns its deployed environment.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MetadataController</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${eureka.instance.metadata-map.env}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">env</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/metadata/env"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">env</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Now just build and run this application twice, once for each environment.</p>

<h4 id="build">Build</h4>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mvn clean package
</code></pre>
</div>

<h4 id="green-environment">Green Environment</h4>

<h5 id="run">Run</h5>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>java -jar target/blue-green-0.0.1-SNAPSHOT.jar
</code></pre>
</div>

<h5 id="validate">Validate</h5>
<p>The <code class="highlighter-rouge">Green app</code> runs on <code class="highlighter-rouge">localhost:8080</code>, to validate its response just request the <code class="highlighter-rouge">endpoint</code> that we
created above.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -i localhost:8080/metadata/env
HTTP/1.1 200
Content-Type: text/plain;charset<span class="o">=</span>UTF-8
Content-Length: 5
Date: Tue, 03 Jul 2018 20:10:55 GMT

green
</code></pre>
</div>

<h4 id="blue-environment">Blue environment</h4>

<h5 id="run-1">Run</h5>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>java -jar target/blue-green-0.0.1-SNAPSHOT.jar --spring.profiles.active<span class="o">=</span>blue
</code></pre>
</div>

<h5 id="validate-1">Validate</h5>
<p>The <code class="highlighter-rouge">Blue app</code> runs on <code class="highlighter-rouge">localhost:8081</code>, to validate its response just request the <code class="highlighter-rouge">endpoint</code> that we
created above.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -i localhost:8081/metadata/env
HTTP/1.1 200
Content-Type: text/plain;charset<span class="o">=</span>UTF-8
Content-Length: 4
Date: Tue, 03 Jul 2018 20:12:23 GMT

blue
</code></pre>
</div>

<h3 id="api-gateway">API Gateway</h3>

<h3 id="summary">Summary</h3>
<p>Congratulations! You just created a blue green deployment using <code class="highlighter-rouge">Spring Cloud Netflix</code> stack.</p>

<h3 id="footnote">Footnote</h3>
<ul>
  <li>The code used for this tutorial can be found on <a href="https://github.com/weekly-drafts/blue-green-deployment-spring-cloud-netflix">GitHub</a></li>
</ul>

      </article>

      
        <div class="blog-tags">
          Tags:
          
          
            <a href="/tags#spring-framework">spring-framework</a>
          
            <a href="/tags#spring-cloud">spring-cloud</a>
          
            <a href="/tags#ha">ha</a>
          
            <a href="/tags#java">java</a>
          
            <a href="/tags#tutorial">tutorial</a>
          
          
        </div>
      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
  <!--- Share on Twitter -->
    <a href="https://twitter.com/intent/tweet?text=Blue-Green+Deployment+with+Spring+Cloud+Netflix+Stack+http://0.0.0.0:4000/blue-green-deployment-spring-cloud-netflix/"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fa fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
  <!--- Share on Facebook -->
    <a href="https://www.facebook.com/sharer/sharer.php?u=http://0.0.0.0:4000/blue-green-deployment-spring-cloud-netflix/"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fa fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
  <!--- Share on Google Plus -->
    <a href="https://plus.google.com/share?url=http://0.0.0.0:4000/blue-green-deployment-spring-cloud-netflix/"
      class="btn btn-social-icon btn-google" title="Share on Google+">
      <span class="fa fa-fw fa-google-plus" aria-hidden="true"></span>
      <span class="sr-only">Google+</span>
    </a>
  

  
  <!--- Share on LinkedIn -->
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://0.0.0.0:4000/blue-green-deployment-spring-cloud-netflix/"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fa fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

</section>



      

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="/pt_BR/graceful-shutdown-spring-boot-apps/" data-toggle="tooltip" data-placement="top" title="Graceful Shutdown Spring Boot Applications">&larr; Previous Post</a>
        </li>
        
        
      </ul>

      
        <div class="disqus-comments">
          <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'marcosbarbero';
        /* ensure that pages with query string get the same discussion */
            var url_parts = window.location.href.split("?");
            var disqus_url = url_parts[0];
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        </div>
      
    </div>
  </div>
</div>


    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links"><li><a href="/pt_BR/feed.xml" title="RSS"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">RSS</span>
              </a>
            </li><li><a href="mailto:marcos.hgb@gmail.com" title="Email me"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Email me</span>
              </a>
            </li><li><a href="https://github.com/marcosbarbero" title="GitHub"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">GitHub</span>
              </a>
            </li><li><a href="https://twitter.com/marcosgbarbero" title="Twitter"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Twitter</span>
              </a>
            </li><li><a href="https://linkedin.com/in/marcosbarbero" title="LinkedIn"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">LinkedIn</span>
              </a>
            </li></ul>
      <p class="copyright text-muted">
      Marcos Barbero
      &nbsp;&bull;&nbsp;
      2018

      
      &nbsp;&bull;&nbsp;
      <a href="http://0.0.0.0:4000/pt_BR/">blog.marcosbarbero.com</a>
      

      
      </p>
          <!-- Please don't remove this, keep my open source work credited :) -->
    <p class="theme-by text-muted">
      Theme by
      <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    </p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/main.js"></script>
    
  



	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-54888300-2', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->


  
  </body>
</html>
