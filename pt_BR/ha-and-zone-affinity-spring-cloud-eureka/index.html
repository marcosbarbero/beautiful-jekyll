<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <meta http-equiv="Content-Language" content="pt_BR">
<link rel="alternate" hreflang="en" href=" http://0.0.0.0:4000/ha-and-zone-affinity-spring-cloud-eureka/"/>
<link rel="alternate" hreflang="pt_BR" href="http://0.0.0.0:4000/pt_BR/ha-and-zone-affinity-spring-cloud-eureka/"/>


  <title>HA e Afinidade de Zonas usando Spring Cloud Netflix Eureka</title>

  <script>
  </script>

  <meta name="author" content="Marcos Barbero" />

  

  <link rel="alternate" type="application/rss+xml" title="Marcos Barbero's Blog - Eu crio coisas e escrevo sobre isso... às vezes." href="/pt_BR/feed.xml" />

  

  
    
      
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />

    
  

  
    
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/css/main.css" />
    
      <link rel="stylesheet" href="/css/flags.min.css" />
    
  

  
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="HA e Afinidade de Zonas usando Spring Cloud Netflix Eureka" />
  

   
  <meta property="og:description" content="Esse tutorial te guiará no processo de configurar zonas de afinidade usando Spring Cloud Netflix Eureka. O que você irá construir Você construirá três aplicações API Gateway - Spring Cloud Netflix Zuul Service Registry - Spring Cloud Netflix Eureka REST Service - Spring Cloud Todas as três aplicações são necessárias...">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="http://0.0.0.0:4000/ha-and-zone-affinity-spring-cloud-eureka/" />
  <link rel="canonical" href="http://0.0.0.0:4000/pt_BR/ha-and-zone-affinity-spring-cloud-eureka/" />
  

  
  <meta property="og:image" content="/img/ha-discovery.jpg" />
  


  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
  <meta name="twitter:title" content="HA e Afinidade de Zonas usando Spring Cloud Netflix Eureka" />
  

  
  <meta name="twitter:description" content="Esse tutorial te guiará no processo de configurar zonas de afinidade usando Spring Cloud Netflix Eureka. O que você irá construir Você construirá três aplicações API Gateway - Spring Cloud Netflix Zuul Service Registry - Spring Cloud Netflix Eureka REST Service - Spring Cloud Todas as três aplicações são necessárias...">
  

  
  <meta name="twitter:image" content="/img/ha-discovery.jpg" />
  

  

</head>


  <body>

    
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand" href="http://0.0.0.0:4000/pt_BR/">Marcos Barbero's Blog</a>
      
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">

      
        
        
        
        
          
        
      
        
        
          
            
              <li>
                <a href="/pt_BR/about/">Sobre mim</a>
              </li>
            
          
        
      
        
        
      
        
        
          
        
      
        
        
          
        
      
        
        
      
        
        
          
        
      


      

        
        <li>
          <a href=" /ha-and-zone-affinity-spring-cloud-eureka/ ">
            <img src="/img/blank.gif" class="flag  flag-us " />
          </a>
        </li>
        
        <li>
          <a href=" /pt_BR/ha-and-zone-affinity-spring-cloud-eureka/ ">
            <img src="/img/blank.gif" class="flag  flag-br " />
          </a>
        </li>
        
      </ul>
    </div>

	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="http://0.0.0.0:4000/pt_BR/">
	      <img class="avatar-img" src="/img/avatar.jpeg" />
		  </a>
	  </div>
	</div>
	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->




  <div id="header-big-imgs" data-num-img=1
    
	  
	  
	    
		  data-img-src-1="/img/ha-discovery.jpg"
		
	  
    
  ></div>





<header class="header-section has-img">

<div class="big-img intro-header">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>HA e Afinidade de Zonas usando Spring Cloud Netflix Eureka</h1>          

		  
		  
		  
		  <span class="post-meta">Posted on March 4, 2018</span>
		  
        </div>
      </div>
    </div>
  </div>
  <span class='img-desc'></span>
</div>

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>HA e Afinidade de Zonas usando Spring Cloud Netflix Eureka</h1>
		  
		  
		  
		  <span class="post-meta">Posted on March 4, 2018</span>
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

      
        
        
        

        <div id="header-gh-btns">
          
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&repo=spring-cloud-eureka-zone-affinity&type=star&count=true" frameborder="0" scrolling="0" width="120px" height="20px"></iframe>
                
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&repo=spring-cloud-eureka-zone-affinity&type=fork&count=true" frameborder="0" scrolling="0" width="120px" height="20px"></iframe>
                
            
              
                  <iframe src="https://ghbtns.com/github-btn.html?user=weekly-drafts&type=follow&count=true" frameborder="0" scrolling="0" width="220px" height="20px"></iframe>
              
            
          
        </div>
      

      <article role="main" class="blog-post">
        <p>Esse tutorial te guiará no processo de configurar zonas de afinidade usando Spring Cloud Netflix Eureka.</p>

<h3 id="o-que-você-irá-construir">O que você irá construir</h3>
<p>Você construirá três aplicações</p>

<ul>
  <li>API Gateway - <a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix Zuul</a></li>
  <li>Service Registry - <a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix Eureka</a></li>
  <li>REST Service - <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a></li>
</ul>

<p>Todas as três aplicações são necessárias para ter certeza que a nossa configuração está correta. Cada uma dela
será deployada duas vezes, uma por zona.</p>

<h3 id="pre-req">Pre-Req</h3>

<ul>
  <li><a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK 1.8</a></li>
  <li>Editor de texto ou IDE</li>
  <li><a href="https://maven.apache.org/download.cgi">Maven 3.0+</a></li>
</ul>

<h3 id="afinidade-de-zonas">Afinidade de Zonas</h3>
<p>Não importa em qual estilo de arquitetura uma aplicação está usando, é um caso de uso muito comum ter a mesma aplicação deployada
em multiplas regiões/data centers e usar algumas técnicas para manter os requests dentro da mesma zona.</p>

<p>Numa arquitetura de microservices, também existe a necessidade de manter o request dentro da mesma zona e isso precisa ser aplicado
usando o <a href="http://microservices.io/patterns/service-registry.html">Design Pattern - Service Registry</a>.</p>

<h3 id="spring-cloud-netflix">Spring Cloud Netflix</h3>
<p><a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix</a> torna fácil a implementação dos 
<a href="http://microservices.io/patterns/">design patterns para microservices</a>.</p>

<h3 id="criando-as-aplicações">Criando as Aplicações</h3>
<p>Nesse tutorial nós criaremos três aplicações, se você tem familiaridade com <code class="highlighter-rouge">spring-cloud</code> isso será muito fácil,
todas as aplicações criadas não são nada além de uma simples aplicação <code class="highlighter-rouge">spring-boot</code>.</p>

<p>A parte principal são os arquivos de configurações que serão mostrados adiante.</p>

<h3 id="dependencias-base">Dependencias Base</h3>
<p>Adicione as seguintes dependencias para todas as aplicações. Se houver alguma dependência específica para alguma aplicação isso 
será mencionado em cada tópico específico.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.5.9.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;dependencyManagement&gt;</span>
        <span class="nt">&lt;dependencies&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>Edgware.SR2<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;/dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-eureka<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
</code></pre></div></div>

<h3 id="api-gateway">API Gateway</h3>
<p>A primeira aplicação que criaremos será o API Gateway usando
<a href="https://cloud.spring.io/spring-cloud-netflix">Spring Cloud Netflix Zuul</a>.
Primeiro adicione a seguinte dependencia no <code class="highlighter-rouge">pom.xml</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">zuul</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div></div>

<h4 id="java-config">Java Config</h4>
<p>Agora basta criar a classe principal e adicionar a anotação <code class="highlighter-rouge">@EnableZuulProxy</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.zuul.EnableZuulProxy</span><span class="o">;</span>

<span class="nd">@EnableZuulProxy</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GatewayApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">GatewayApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="service-registry">Service Registry</h3>
<p>A segunda aplicação que criaremos é o Service Registry usando
<a href="https://cloud.spring.io/spring-cloud-netflix">Spring Cloud Netflix Eureka</a>.
Primeiro adicione a seguinte dependência ao <code class="highlighter-rouge">pom.xml</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h4 id="java-config-1">Java Config</h4>
<p>Agora basta criar a classe principal e adicionar a anotação <code class="highlighter-rouge">@EnableEurekaServer</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class="o">;</span>

<span class="nd">@EnableEurekaServer</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceDiscoveryApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ServiceDiscoveryApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="rest-service">REST Service</h3>
<p>A terceira aplicação contém nada além de um endoint REST que retorna a <code class="highlighter-rouge">zona</code> onde a aplicação está rodando,
apenas para termos certeza de que cada request se manterá na mesma região.</p>

<p>Para essa aplicação não há necessidade de acrescentar nenhuma dependência específica.</p>

<h4 id="java-config-2">Java Config</h4>
<p>Para facilitar as coias eu estou criando uma classe aninhada que será nosso <code class="highlighter-rouge">RestController</code>, esse controller retornará a zona onde a 
aplicação foi deployada.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_UTF8_VALUE</span><span class="o">;</span>

<span class="nd">@EnableDiscoveryClient</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SimpleService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@RestController</span>
    <span class="kd">class</span> <span class="nc">SimpleController</span> <span class="o">{</span>
        <span class="nd">@Value</span><span class="o">(</span><span class="s">"${eureka.instance.metadataMap.zone}"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">zone</span><span class="o">;</span>
        <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/zone"</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="n">APPLICATION_JSON_UTF8_VALUE</span><span class="o">)</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">zone</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"{\"zone\"=\""</span> <span class="o">+</span> <span class="n">zone</span> <span class="o">+</span> <span class="s">"\"}"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="properties">Properties</h4>
<p>Como ceitei anteriormente, cada aplicação precisa ser deployada duas vezes para simular duas zonas distintas,
para facilitar nós criaremos as configurações baseadas em <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html">profiles</a>, 
para cada aplicação nós criaremos os seguintes três arquivos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>src/main/resources/application.yml
src/main/resources/application-zone1.yml
src/main/resources/application-zone2.yml
</code></pre></div></div>

<p class="box-note">O sufixo no nome do arquivo será usado como nome do profile.</p>

<h4 id="service-registry-1">Service Registry</h4>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application.yml</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">register-with-eureka</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">fetch-registry</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">region</span><span class="pi">:</span> <span class="s">region-1</span>
    <span class="na">service-url</span><span class="pi">:</span>
      <span class="na">zone1</span><span class="pi">:</span> <span class="s">http://localhost:8761/eureka/</span>
      <span class="na">zone2</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8762/eureka/</span>
    <span class="na">availability-zones</span><span class="pi">:</span>
      <span class="na">region-1</span><span class="pi">:</span> <span class="s">zone1,zone2</span>
<span class="s">spring.profiles.active</span><span class="pi">:</span> <span class="s">zone1</span>
</code></pre></div></div>

<p>Todas as seguintes propriedades estão debaixo da propriedade <code class="highlighter-rouge">eureka.client</code>.</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>region</td>
      <td>Uma String contendo o nome da região onde a aplicação será deployada</td>
    </tr>
    <tr>
      <td>service-url</td>
      <td>Um mapa contendo uma lista URLs com as zonas de disponibilidade para a região</td>
    </tr>
    <tr>
      <td>availability-zones</td>
      <td>Um mapa contendo uma lista delimitada por vírgula contendo uma lista de zonas</td>
    </tr>
  </tbody>
</table>

<p>As propriedades <code class="highlighter-rouge">register-with-eureka</code> e <code class="highlighter-rouge">fetch-registry</code> estão previnindo que o Eureka Server seja adicionado para a lista de aplicações,
mas isso não é tão importante para esse tutorial.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone1.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8761</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">instance</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">localhost</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone1</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone2.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8762</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">instance</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone2</span>
</code></pre></div></div>

<p>Para os profiles <code class="highlighter-rouge">-zone1</code> e <code class="highlighter-rouge">-zone2</code> a única diferença é o <code class="highlighter-rouge">server.port</code>, a zona está configurada em
<code class="highlighter-rouge">eureka.metadataMap.zone</code>, e nesse caso o hostname, cada Eureka Server precisa rodar em hosts diferentes,
como eu estou executando ambos no mesmo host eu estou nomeando como <code class="highlighter-rouge">127.0.0.1</code> e <code class="highlighter-rouge">localhost</code>.</p>

<p class="box-note">Não é necessário adicionar o hostname caso você esteja rodando em hosts diferentes.</p>

<h4 id="gateway">Gateway</h4>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application.yml</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">prefer-same-zone-eureka</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">region</span><span class="pi">:</span> <span class="s">region-1</span>
    <span class="na">service-url</span><span class="pi">:</span>
      <span class="na">zone1</span><span class="pi">:</span> <span class="s">http://localhost:8761/eureka/</span>
      <span class="na">zone2</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8762/eureka/</span>
    <span class="na">availability-zones</span><span class="pi">:</span>
      <span class="na">region-1</span><span class="pi">:</span> <span class="s">zone1,zone2</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="s">profiles.active</span><span class="pi">:</span> <span class="s">zone1</span>
  <span class="s">application.name</span><span class="pi">:</span> <span class="s">gateway</span>
<span class="s">management.security.enabled</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<p>The main difference here is the property <code class="highlighter-rouge">eureka.client.prefer-same-zone-eureka</code>, it is telling to the application that 
whenever it needs to make a call to another <code class="highlighter-rouge">EurekaClient</code> it will call it using the same zone where the caller is deployed. 
In case there’s no available client in the same zone, it will call from another zone in which it’s available.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone1.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8080</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">instance</span><span class="pi">:</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone1</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone2.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8081</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">instance</span><span class="pi">:</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone2</span>
</code></pre></div></div>

<p>Como antes, a única mudança entre os perfis são a zona de disponibilidade e a porta.</p>

<h4 id="rest-service-1">REST Service</h4>
<p>Esse serviço tem a mesma configuração do API Gateway.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application.yml</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">prefer-same-zone-eureka</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">region</span><span class="pi">:</span> <span class="s">region-1</span>
    <span class="na">service-url</span><span class="pi">:</span>
      <span class="na">zone1</span><span class="pi">:</span> <span class="s">http://localhost:8761/eureka/</span>
      <span class="na">zone2</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8762/eureka/</span>
    <span class="na">availability-zones</span><span class="pi">:</span>
      <span class="na">region-1</span><span class="pi">:</span> <span class="s">zone1,zone2</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="s">profiles.active</span><span class="pi">:</span> <span class="s">zone1</span>
  <span class="s">application.name</span><span class="pi">:</span> <span class="s">simple-service</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone1.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8181</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">instance</span><span class="pi">:</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone1</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main/resources/application-zone2.yml</span>
<span class="s">server.port</span><span class="pi">:</span> <span class="s">8182</span>
<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">instance</span><span class="pi">:</span>
    <span class="s">metadataMap.zone</span><span class="pi">:</span> <span class="s">zone2</span>
</code></pre></div></div>

<h3 id="build--run">Build &amp; Run</h3>
<p>Agora é hora de compilar as aplicações, se (assim como eu) você está usando maven então apenas execute:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mvn clean package
</code></pre></div></div>

<p>Logo após isso execute cada aplicação adicionando o profile específico, por exemplo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>java <span class="nt">-jar</span> target/<span class="k">*</span>.jar <span class="nt">--spring</span>.profiles.active<span class="o">=</span>zone1
</code></pre></div></div>

<p class="box-note">Lembre-se que você precisará executar duas vezes cada aplicação, uma para cada profile: <code class="highlighter-rouge">zone1</code> e <code class="highlighter-rouge">zone2</code>.</p>

<h3 id="validando">Validando</h3>
<p>Para validar se cada request está respeitando as zonas nós faremos o request através do Gateway.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://localhost:8080/simple-service/zone
<span class="o">{</span><span class="s2">"zone"</span><span class="o">=</span><span class="s2">"zone1"</span><span class="o">}</span>
<span class="nv">$ </span>curl http://localhost:8081/simple-service/zone
<span class="o">{</span><span class="s2">"zone"</span><span class="o">=</span><span class="s2">"zone2"</span><span class="o">}</span>
</code></pre></div></div>

<p class="box-note">A única diferença entre cada zona é a porta onde o serviço está rodando.</p>

<h3 id="validando-o-failover-das-zonas">Validando o failover das zonas</h3>
<p>Para validar o failover entre as zonas você so precisa parar uma das instancias e fazer o request na zona oposta, exemplo:</p>

<ol>
  <li>Pare o serviço <code class="highlighter-rouge">simple-service</code> na zone2.</li>
  <li>Faça um request para o <code class="highlighter-rouge">simple-service</code> na zone2 através do Gateway.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://localhost:8081/simple-service/zone
</code></pre></div></div>

<p>Agora o resultado experado é um <code class="highlighter-rouge">JSON</code> contendo <code class="highlighter-rouge">{"zone"="zone1"}</code>.<br />
Uma vez que o <code class="highlighter-rouge">simple-service</code> volte a rodar e está registrado no Eureka Server o mesmo request deve voltar a responder <code class="highlighter-rouge">{"zone"="zone2"}</code>.</p>

<p class="box-note">Leva algum tempo até que o <code class="highlighter-rouge">simple-service</code> esteja disponível na zona oposta, seja paciente e divirta-se!</p>

<h3 id="sumário">Sumário</h3>
<p>Parabéns! Você acabou de criar e configurar um API Gateway, Service Registry e um serviço REST que resposta zonas de afinidade
trazendo mais resiliencia e disponibilidade para os teus microservices.</p>

<h3 id="nota-de-rodapé">Nota de Rodapé</h3>
<ul>
  <li>O código usado nesse tutorial pode ser encontrado no <a href="https://github.com/weekly-drafts/spring-cloud-eureka-zone-affinity">GitHub</a></li>
</ul>

      </article>

      
        <div class="blog-tags">
          Tags:
          
          
            <a href="/tags#spring-framework">spring-framework</a>
          
            <a href="/tags#spring-cloud">spring-cloud</a>
          
            <a href="/tags#ha">ha</a>
          
            <a href="/tags#netflix">netflix</a>
          
            <a href="/tags#tutorial">tutorial</a>
          
          
        </div>
      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
  <!--- Share on Twitter -->
    <a href="https://twitter.com/intent/tweet?text=HA+e+Afinidade+de+Zonas+usando+Spring+Cloud+Netflix+Eureka+http://0.0.0.0:4000/ha-and-zone-affinity-spring-cloud-eureka/"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fa fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
  <!--- Share on Facebook -->
    <a href="https://www.facebook.com/sharer/sharer.php?u=http://0.0.0.0:4000/ha-and-zone-affinity-spring-cloud-eureka/"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fa fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
  <!--- Share on Google Plus -->
    <a href="https://plus.google.com/share?url=http://0.0.0.0:4000/ha-and-zone-affinity-spring-cloud-eureka/"
      class="btn btn-social-icon btn-google" title="Share on Google+">
      <span class="fa fa-fw fa-google-plus" aria-hidden="true"></span>
      <span class="sr-only">Google+</span>
    </a>
  

  
  <!--- Share on LinkedIn -->
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://0.0.0.0:4000/ha-and-zone-affinity-spring-cloud-eureka/"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fa fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

</section>



      

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="/pt_BR/setup-multiple-datasources-with-spring-boot-spring-data-in-pcf/" data-toggle="tooltip" data-placement="top" title="Configurando mutiplos DataSources com Spring Boot e Spring Data - PCF">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="/pt_BR/spring-cloud-netflix-zuul-rate-limit/" data-toggle="tooltip" data-placement="top" title="Adicionando Rate Limit no Spring Cloud Netflix Zuul">Next Post &rarr;</a>
        </li>
        
      </ul>

      
        <div class="disqus-comments">
          <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'marcosbarbero';
        /* ensure that pages with query string get the same discussion */
            var url_parts = window.location.href.split("?");
            var disqus_url = url_parts[0];
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        </div>
      
    </div>
  </div>
</div>


    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links"><li><a href="/pt_BR/feed.xml" title="RSS"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">RSS</span>
              </a>
            </li><li><a href="mailto:marcos.hgb@gmail.com" title="Email me"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Email me</span>
              </a>
            </li><li><a href="https://github.com/marcosbarbero" title="GitHub"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">GitHub</span>
              </a>
            </li><li><a href="https://twitter.com/marcosgbarbero" title="Twitter"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Twitter</span>
              </a>
            </li><li><a href="https://linkedin.com/in/marcosbarbero" title="LinkedIn"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">LinkedIn</span>
              </a>
            </li></ul>
      <p class="copyright text-muted">
      Marcos Barbero
      &nbsp;&bull;&nbsp;
      2019

      
      &nbsp;&bull;&nbsp;
      <a href="http://0.0.0.0:4000/pt_BR/">blog.marcosbarbero.com</a>
      

      
      </p>
          <!-- Please don't remove this, keep my open source work credited :) -->
    <p class="theme-by text-muted">
      Theme by
      <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    </p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/main.js"></script>
    
  



	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-54888300-2', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->


  
  </body>
</html>
